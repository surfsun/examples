<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>插件延迟队列 - RabbitMQ 教学</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<nav class="navbar"><div class="container" style="max-width:1200px;display:flex;justify-content:space-between;align-items:center;">
    <a class="navbar-brand" th:href="@{/}"><i class="fas fa-plug"></i> RabbitMQ 教学平台</a>
    <div style="display:flex;gap:1.5rem;"><a class="nav-link" th:href="@{/}">首页</a><a class="nav-link" th:href="@{/quiz}">知识问答</a></div>
</div></nav>
<div class="main-container demo-page">
    <a th:href="@{/}" class="back-link"><i class="fas fa-arrow-left"></i> 返回首页</a>
    <h2><i class="fas fa-bolt" style="color:var(--accent-pink)"></i> 插件延迟队列</h2>
    <p class="subtitle">x-delayed-message Plugin — 精准延迟，无队头阻塞</p>

    <div class="panel">
        <div class="panel-title"><i class="fas fa-project-diagram"></i> 架构图解</div>
        <div class="flow-diagram">
            <div class="flow-node producer"><i class="fas fa-user" style="color:var(--accent-blue)"></i><span class="label">生产者</span><span class="sub">设置 x-delay</span></div>
            <div class="flow-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
            <div class="flow-node exchange"><i class="fas fa-exchange-alt" style="color:var(--accent-pink)"></i><span class="label">Delayed Exchange</span><span class="sub">消息暂存/计时</span></div>
            <div class="flow-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
            <div class="flow-node queue"><i class="fas fa-inbox" style="color:var(--accent-orange)"></i><span class="label">队列</span><span class="sub">到期投递</span></div>
            <div class="flow-arrow"><i class="fas fa-long-arrow-alt-right"></i></div>
            <div class="flow-node consumer"><i class="fas fa-cog" style="color:var(--accent-green)"></i><span class="label">消费者</span></div>
        </div>
    </div>

    <div class="panel control-panel">
        <div class="panel-title"><i class="fas fa-paper-plane"></i> 发送延迟消息</div>
        <div style="display:flex;gap:0.75rem;margin-bottom:0.75rem;">
            <input type="text" class="form-control" id="msgInput" placeholder="消息内容..." value="精准定时任务">
            <input type="number" class="form-control" id="delayInput" placeholder="延迟(ms)" value="3000" style="max-width:140px;">
            <button class="btn-send" onclick="doSend()" style="white-space:nowrap;"><i class="fas fa-bolt"></i> 发送</button>
        </div>
        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
            <button class="btn-preset" onclick="doDelay('2秒后投递',2000)">⚡ 2秒</button>
            <button class="btn-preset" onclick="doDelay('5秒后投递',5000)">⚡ 5秒</button>
            <button class="btn-preset" onclick="doDelay('8秒后投递',8000)">⚡ 8秒</button>
            <button class="btn-preset" onclick="doBatchDelay()">🔀 乱序测试</button>
        </div>
        <p style="font-size:0.75rem;color:var(--text-secondary);margin-top:0.5rem;">
            💡 点击"乱序测试"同时发送 10s、3s、7s 延迟的消息，观察到达顺序不受发送顺序影响
        </p>
    </div>

    <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div class="panel-title" style="margin-bottom:0;"><i class="fas fa-stream"></i> 实时消息日志</div>
            <button class="btn-preset" onclick="clearLogs('logBox')">清空</button>
        </div>
        <div id="logBox" class="log-container" style="margin-top:0.75rem;">
            <div class="log-empty"><i class="fas fa-inbox"></i> 暂无消息</div>
        </div>
    </div>

    <!-- 对比表格 -->
    <div class="panel">
        <div class="panel-title"><i class="fas fa-balance-scale"></i> TTL+DLX vs 插件对比</div>
        <table class="compare-table">
            <tr><th>特性</th><th>x-delayed-message 插件</th><th>TTL + DLX 方式</th></tr>
            <tr><td>延迟精度</td><td style="color:var(--accent-green)">✅ 毫秒级精确</td><td style="color:var(--accent-red)">❌ 受FIFO限制</td></tr>
            <tr><td>乱序延迟</td><td style="color:var(--accent-green)">✅ 支持</td><td style="color:var(--accent-red)">❌ 不支持</td></tr>
            <tr><td>实现复杂度</td><td style="color:var(--accent-green)">✅ 简单</td><td style="color:var(--accent-red)">❌ 复杂</td></tr>
            <tr><td>插件依赖</td><td style="color:var(--accent-orange)">⚠️ 需要安装插件</td><td style="color:var(--accent-green)">✅ 原生支持</td></tr>
            <tr><td>消息持久化</td><td style="color:var(--accent-orange)">⚠️ Mnesia 存储</td><td style="color:var(--accent-green)">✅ 队列持久化</td></tr>
        </table>
    </div>
</div>
<div class="footer">© 2025 RabbitMQ 教学平台</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/app.js}"></script>
<script>
    connectSSE('plugindelay', 'logBox');
    function doSend() {
        const msg = document.getElementById('msgInput').value.trim();
        const delay = parseInt(document.getElementById('delayInput').value) || 3000;
        if (!msg) return showToast('请输入消息', 'error');
        sendMsg('/api/plugin-delay', {message: msg, delayMs: delay});
    }
    function doDelay(msg, ms) {
        document.getElementById('msgInput').value = msg;
        document.getElementById('delayInput').value = ms;
        doSend();
    }
    function doBatchDelay() {
        sendMsg('/api/plugin-delay', {message: '第1个发送(10s延迟)', delayMs: 10000});
        sendMsg('/api/plugin-delay', {message: '第2个发送(3s延迟)', delayMs: 3000});
        sendMsg('/api/plugin-delay', {message: '第3个发送(7s延迟)', delayMs: 7000});
        showToast('已发送乱序测试：10s、3s、7s，观察到达顺序', 'success');
    }
    document.getElementById('msgInput').addEventListener('keypress', e => { if(e.key==='Enter') doSend(); });
</script>
</body>
</html>
